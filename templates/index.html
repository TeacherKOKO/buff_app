<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>バフ比較計算機</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='snow.js') }}"></script>
</head>
<body>
    <div class="snow"></div>
    <h1>❄ White Out Survival バフ計算機 ❄</h1>
    <p>Presented by ココ先生 form #2501</p>  
    
    <form method="POST">
        <div class="unit-section">
            <h2>味方ユニット</h2>
            <ul>
                {% for label in unit_labels %}
                    <li>
                        <label>{{ label }}</label>
                        <input type="text" name="u{{ loop.index }}" class="comma-input"
                               value="{{ request.form.get('u' ~ loop.index, loaded_data.get('u' ~ loop.index, '')) }}">
                    </li>
                {% endfor %}
            </ul>

            <h2>味方バフ</h2>
            <ul>
                {% for i in range(0, 20, 4) %}
                    <li><strong>{{ unit_labels[i // 4] }}</strong></li>
                    {% for j in range(4) %}
                        <li>
                            <label>{{ buff_labels[j] }}</label>
                            <input type="text" name="{{ buff_vars[i + j] }}" class="comma-input"
                                   value="{{ request.form.get(buff_vars[i + j], loaded_data.get(buff_vars[i + j], '')) }}">
                        </li>
                    {% endfor %}
                {% endfor %}
            </ul>
        </div>

        <div class="unit-section">
            <h2>敵ユニット</h2>
            <ul>
                {% for label in unit_labels %}
                    <li>
                        <label>{{ label }}</label>
                        <input type="text" name="v{{ loop.index }}" class="comma-input"
                               value="{{ request.form.get('v' ~ loop.index, loaded_data.get('v' ~ loop.index, '')) }}">
                    </li>
                {% endfor %}
            </ul>

            <h2>敵バフ</h2>
            <ul>
                {% for i in range(20, 40, 4) %}
                    <li><strong>{{ unit_labels[(i - 20) // 4] }}</strong></li>
                    {% for j in range(4) %}
                        <li>
                            <label>{{ buff_labels[j] }}</label>
                            <input type="text" name="{{ buff_vars[i + j] }}" class="comma-input"
                                   value="{{ request.form.get(buff_vars[i + j], loaded_data.get(buff_vars[i + j], '')) }}">
                        </li>
                    {% endfor %}
                {% endfor %}
            </ul>
        </div>

        <div class="form-actions">
            <input type="submit" value="計算">
            <input type="text" name="save_name" placeholder="保存名（任意）">
            <button type="submit" name="action" value="save">保存</button>
        </div>
    </form>

    {% if results %}
    <div class="results">
        <h2>結果</h2>
        <p>味方合計: {{ results.total_w | round(2) | int | string | replace(",", "") | int | format(",") }}</p>
        <p>敵合計: {{ results.total_x | round(2) | int | string | replace(",", "") | int | format(",") }}</p>
        <pre>{{ results.message }}</pre>
    </div>
    {% endif %}

    {% if saved_names %}
    <div class="saved-results">
        <h2>保存済みデータ</h2>
        <ul>
            {% for name in saved_names %}
            <li>
                {{ name }}
                <form method="POST" style="display:inline;">
                    <input type="hidden" name="load_name" value="{{ name }}">
                    <button type="submit" name="action" value="load">読み込み</button>
                    <button type="submit" name="action" value="delete">削除</button>
                </form>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <script>
        document.querySelectorAll('.comma-input').forEach(input => {
            input.addEventListener('input', function () {
                let cursorPos = this.selectionStart;
                let rawValue = this.value.replace(/,/g, '');
                if (!isNaN(rawValue) && rawValue !== '') {
                    this.value = Number(rawValue).toLocaleString();
                    this.setSelectionRange(cursorPos, cursorPos);
                }
            });
        });
    </script>
</body>
</html>